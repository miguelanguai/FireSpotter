import{pointsTracker}from"./wildfire-tracker.js";import{redIcon,map,countryMarker,drawLinesWithSecondaryLines}from"./map-builder.js";async function pointsPrinter(source,country){const{abbreviation:abbreviation,name:name,coordinates:coordinates}=country;let trackedPoints;countryMarker.clearLayers(),map.setView(coordinates,6);const key=`${name}, ${source}`,storedPoints=getWithTTL(key);storedPoints?trackedPoints=storedPoints:(trackedPoints=await pointsTracker(source,abbreviation),setWithTTL(key,JSON.stringify(trackedPoints)));for(const type in trackedPoints)for(const points of trackedPoints[type])for(const point of points){const{nearbyCity:nearbyCity,frp:frp,propagation:propagation,latitude:latitude,longitude:longitude,windDeg:windDeg,windSpeed:windSpeed}=point,isFire="fires"===type,toolTip=`<h4>${nearbyCity}</h4><hr><p>Prediction: `+type.replace(/(?:^|\s)./g,(match=>match.toUpperCase())).replace(/([A-Z])/g," $1").trim()+"</p>"+`<p>Source: ${source}</p>`+`<p>Radiative Power: ${frp}</p>`+(isFire?"<p>Fire propagation: "+propagation.toFixed(2)+" meters</p>":"")+`<p>latitude: ${latitude}</p>`+`<p>longitude: ${longitude}</p>`+`<p>Wind degrees: ${windDeg} degrees</p>`+`<p>Wind speed: ${windSpeed} meters/sec</p>`,pointMarker=L.marker([latitude,longitude],{icon:redIcon}).bindTooltip(toolTip);countryMarker.addLayer(pointMarker),isFire&&drawLinesWithSecondaryLines(latitude,longitude,windDeg,propagation)}}function setWithTTL(key,content,ttl=300){ttl*=1e3;const value={content:content,expiry:(new Date).getTime()+ttl};localStorage.setItem(key,JSON.stringify(value))}function getWithTTL(key){let value=null;const rawValue=localStorage.getItem(key);if(rawValue){const{content:content,expiry:expiry}=JSON.parse(rawValue),now=new Date;expiry&&now.getTime()>expiry?localStorage.removeItem(key):value=JSON.parse(content)}return value}async function main(){const rawCountries=await fetch("assets/js/countries.json"),countries=await rawCountries.json(),country=countryName=>countries.find((country=>country.name===countryName)),sources=["VIIRS_NOAA20_NRT","VIIRS_SNPP_NRT","MODIS_NRT"],defaultSource=sources[0];pointsPrinter(defaultSource,country("Spain"));const countrySelector=document.getElementById("countrySelector");countries.forEach((country=>{const option=document.createElement("option"),name=country.name;option.value=name,option.text=name,"Spain"===name&&(option.selected=!0),countrySelector.appendChild(option)}));const sourceSelector=document.getElementById("sourceSelector");function printBySelection(){const selectedCountry=countrySelector.options[countrySelector.selectedIndex].value;pointsPrinter(sourceSelector.options[sourceSelector.selectedIndex].value,country(selectedCountry))}sources.forEach((source=>{const option=document.createElement("option");option.value=source,option.text=source,source===defaultSource&&(option.selected=!0),sourceSelector.appendChild(option)})),countrySelector.addEventListener("change",printBySelection),sourceSelector.addEventListener("change",printBySelection)}main();